pipeline {
    agent any

    environment {
        TOKEN_URL = 'https://cp-console-cp4ba-dev.apps.cp4ba.linuxtechi.lan/idprovider/v1/auth/identitytoken'
        CLIENT_ID = 'rm9egkx2wa7px4ngudn36z06omfsy91d'
        USERNAME  = 'cp4badmin'
        PASSWORD  = 'Abc@123'
        ACCESS_TOKEN = ''
        SECURITY_TOKEN = ''
        JSON_ICN=''
        PATH_PLUGIN='/opt/ibm/plugins/TestABC.jar'
        URL_ICN_LOGON='https://navigator-cp4ba-dev.apps.cp4ba.linuxtechi.lan/navigator/jaxrs/logon';
        URL_ICN_LOAD_PLUGIN='https://navigator-cp4ba-dev.apps.cp4ba.linuxtechi.lan/navigator/jaxrs/admin/loadPlugin'
    }

    stages {
        stage('Get Access Token') {
            steps {
                bat '''
                    echo Calling API to get access token...

                    rem --- Gọi API và lưu kết quả ra file tạm ---
                    curl -k -X POST "%TOKEN_URL%" ^
                      -H "Content-Type: application/x-www-form-urlencoded" ^
                      -d "grant_type=password&client_id=%CLIENT_ID%&username=%USERNAME%&password=%PASSWORD%&scope=openid" ^
                      -o response.json
					
					echo === response (raw JSON) ===
                    type response.json
                    echo ===============================
                    
                    rem --- Parse access_token từ JSON bằng PowerShell ---
                    for /f "delims=" %%a in ('powershell -NoProfile -Command "(Get-Content response.json | ConvertFrom-Json).access_token"') do (
                        set ACCESS_TOKEN=%%a
                    )

                    echo Access Token: %ACCESS_TOKEN%

                    rem --- Ghi token vào file để stage sau có thể đọc ---
                    echo %ACCESS_TOKEN% > token.txt
                    
                    curl -k -c cookies.txt ^
                      -H "Authorization: Bearer %ACCESS_TOKEN%" ^
                      "%URL_ICN_LOGON%?desktop=admin&forceBasic=true" ^
                      -H "Content-Type: application/x-www-form-urlencoded" ^
                      -d "userid=%USERNAME%&password=%PASSWORD%" ^
                      -o icnresponse.json

					echo === ICN Response (raw JSON) ===
                    type icnresponse.json
                    echo ===============================

					rem for /f "usebackq delims=" %%a in ('powershell -NoProfile -Command ^
 					rem "$raw = Get-Content icnresponse.json -Raw; $json = $raw.Substring($raw.IndexOf('{', 2)); (ConvertFrom-Json $json).security_token"') do (
					rem 	set SECURITY_TOKEN=%%a
 					rem )
					rem echo Security Token: %SECURITY_TOKEN%

					for /f "usebackq delims=" %%a in (`
					    powershell -NoProfile -Command ^
					    "$raw = Get-Content 'icnresponse.json' -Raw; " ^
					    "$json = $raw.Substring($raw.IndexOf('{', 2)); " ^
					    "Write-Output ((ConvertFrom-Json $json).security_token)"
					`) do (
					    set SECURITY_TOKEN=%%a
					)
					
                    curl -k -b cookies.txt ^
                      -H "security_token: %SECURITY_TOKEN%" ^
                      -X POST "%URL_ICN_LOAD_PLUGIN%?desktop=admin&fileName=%PATH_PLUGIN%" ^
                      -o icnload.json
                    
					curl -k -b cookies.txt ^
                      -H "security_token: %SECURITY_TOKEN%" ^
                      -X POST "%URL_ICN_LOAD_PLUGIN%?desktop=admin&fileName=%PATH_PLUGIN%" ^
                      -o icnload.json
                      
					for /f "usebackq delims=" %%a in (`
					    powershell -NoProfile -Command ^
					    "$raw = Get-Content 'icnload.json' -Raw; " ^
					    "$json = $raw.Substring($raw.IndexOf('{', 2)); " ^
					    "Write-Output $json"
					`) do (
					    set JSON_ICN=%%a
					)              
 
                '''
            }
        }

        stage('Use Token') {
            steps {
                bat '''
                    rem --- Đọc lại token ---
                    rem set /p ACCESS_TOKEN=<token.txt
                    rem echo Using token: %ACCESS_TOKEN%

                    rem --- Ví dụ dùng token cho API khác ---
                    rem curl -k -H "Authorization: Bearer %ACCESS_TOKEN%" https://example.com/api/test
                    rem curl -k -c cookies.txt -H "Authorization: Bearer %ACCESS_TOKEN%" "https://navigator-cp4ba-dev.apps.cp4ba.linuxtechi.lan/navigator/jaxrs/logon?desktop=admin" -H "Content-Type: application/x-www-form-urlencoded" -d "userid=%USERNAME%&password=%PASSWORD%"
					
                    
                '''
            }
        }
    }

    post {
        always {
            echo "Cleaning temporary files..."
            bat 'if exist response.json del response.json'
            bat 'if exist token.txt del token.txt'
            bat 'if exist icn_response.json del icn_response.json'
            bat 'if exist icn_token.txt del icn_token.txt'
        }
    }
}