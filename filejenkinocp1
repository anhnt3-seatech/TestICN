pipeline {
    agent any
    
    tools {
        ant 'ApacheAnt'   // Cấu hình tool Ant trong Jenkins
    }

    environment {
        NAMESPACE = "cp4ba-dev"          // namespace CP4BA
        ICN_LABEL = "app=icp4adeploy-navigator-deploy"                  // label để tìm pod ICN
        PLUGIN_PATH = "/opt/ibm/plugins"
        PLUGIN_CLASS = "com.vn.test.TestABCPlugin"  // class plugin chính
        ICN_URL = "https://cpd-cp4ba-dev.apps.cp4ba.linuxtechi.lan/icn/navigator/"
        PATH = "C:\\temp\\ocp;${env.PATH}"
    }

    stages {
        stage('Checkout') {
            steps {
                git 'https://github.com/anhnt3-seatech/TestICN.git'
            }
        }

        stage('Build Plugin') {
            steps {
                bat 'ant clean compile dist'
            }
        }
        
        stage('Archive Artifact') {
            steps {
                archiveArtifacts artifacts: 'dist/*.jar', fingerprint: true
            }
        }
        
        stage('Deploy to ICN Pod') {
            steps {
                script {
                    bat """
                        echo ">>> Login to OpenShift"
                        oc login --token=sha256~Ptmp1_AGNEkb0gmfJ2kEGWxdq4MEonq5we5gWDaPbKQ --server=https://api.cp4ba.linuxtechi.lan:6443 --insecure-skip-tls-verify=true
                        echo ">>> Switch namespace"
                        oc project %NAMESPACE%

                        echo ">>> Get ICN pod name"
                        for /f "delims=" %%i in ('oc get pod -n cp4ba-dev -l app^=icp4adeploy-navigator-deploy -o jsonpath^="{.items[0].metadata.name}"') do set ICN_POD=%%i
                        echo Found ICN pod: %ICN_POD%
                        if "%ICN_POD%"=="" (
                            echo "ERROR: Không tìm thấy ICN pod!"
                            exit /b 1
                        )

                        echo ">>> Copy plugin JAR to ICN pod"
                        oc cp dist\\TestABC.jar %NAMESPACE%/%ICN_POD%:%PLUGIN_PATH%/

                    """
                }
            }
        }
        stage('Reload Plugin') {
            steps {
                script {
                    bat """
                        echo ">>> Try reload ICN plugin"
                        curl -k -X POST "%ICN_URL%/configuration?action=loadPlugin&pluginClass=%PLUGIN_CLASS%"
                        echo ">>>oc delete pod -n cp4ba-dev -l app=icp4adeploy-navigator-deploy"
                    """
                }
            }
        }
    }

    post {
        success {
            echo "✅ ICN Plugin build & deploy thành công!"
        }
        failure {
            echo "❌ Pipeline thất bại!"
        }
    }
}